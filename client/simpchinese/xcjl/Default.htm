<HTML xmlns:zydsoft="http://www.zydsoft.com">
<head>
    <title>寻宠记录</title>
    <meta http-equiv="Content-Type" content="text/html; charset=gb2312">
    <link rel="stylesheet" href="/client/defaultcss.asp" type="text/css">
    <script src="/client/netpower2.js"></script>
    <script src="/client/utility.js"></script>
    <script src="/client/defmapfunc.js"></script>
    <script src="/client/interfacewindow.js"></script>
    <script src="/client/interfacestyle.js"></script>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=QOxYNILEmh3DwwGt92DkzZ2V8X1feD9A"></script>

</head>
<body onselectstart="if (window.event.srcElement.tagName!='INPUT')return false;" ondragstart="if (window.event.srcElement.tagName!='INPUT')return false;" oncontextmenu="if (window.event.srcElement.tagName!='INPUT')return false;" onload="bodyonload();">
    <input id="ID" type="hidden"><input id="placepoint" type="hidden" /><input id="imgText" type="hidden" />
    <table align="center">
        <tr>
            <td align="center" class="caption" style="padding-bottom:20px;">寻宠记录</td>
        </tr>
        <tr style="display:none;" id="isFind">
            <td align="center">
                <button style="height:30px;color:#090; margin-bottom:20px;">已发现目标，点击查看</button>
            </td>
        </tr>
        <tr>
            <td>
                <zydsoft:optionlab width="100%" stylename="xp" id="menu">
                    <zydsoft:lab run="selectlab(0)" checked="checked">基本情况</zydsoft:lab>
                    <zydsoft:lab run="selectlab(1)">处理内容</zydsoft:lab>
                    <!--<zydsoft:lab run="selectlab(2)">模糊匹配结果</zydsoft:lab>-->
                </zydsoft:optionlab>
            </td>
        </tr>
        <tr>
            <td id="labcont" valign="top" style="padding-top:20px;">
                <b>
                    <table align="center">
                        <tr>
                            <td valign="top">
                                <table align="center">
                                    <tr>
                                        <td>
                                            捡到：
                                        </td>
                                        <td>
                                            <input id="sendType" type="checkbox"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            疑似重复：
                                        </td>
                                        <td>
                                            <input id="isRe" type="checkbox" disabled/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            走失时间：
                                        </td>
                                        <td>
                                            <input id="timeInput" disabled/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            走失地点：
                                        </td>
                                        <td>
                                            <input id="placeText" size="40" disabled /><button id="selectPlace" onclick="selectPlaceClick()" style="display:none;">选择地点</button>
                                        </td>
                                    </tr>
                                    <tr id="mapTR" style="display:none;">
                                        <td valign=top>地图：</td>
                                        <td><div id="allmap" style="width:300px; height:200px;"></div></td>
                                    </tr>
                                    <tr>
                                        <td>
                                            品种：
                                        </td>
                                        <td>
                                            <input id="Varieties" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            性别：
                                        </td>
                                        <td>
                                            <input id="Gender" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            绝育：
                                        </td>
                                        <td>
                                            <input id="sterilization" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            颜色：
                                        </td>
                                        <td>
                                            <input id="color" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            主人姓名：
                                        </td>
                                        <td>
                                            <input id="isname" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            手机：
                                        </td>
                                        <td>
                                            <input id="phone" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            赏金：
                                        </td>
                                        <td>
                                            <input id="amount" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td valign=top>
                                            更多特征：
                                        </td>
                                        <td>
                                            <textarea  id="memo" rows="5" style="width:300px;"></textarea >
                                        </td>
                                    </tr>
                                    <tr id="imgTR" style="display:none;">
                                        <td valign=top>图片</td>
                                        <td id="imgTD">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            提交时间：
                                        </td>
                                        <td>
                                            <input id="CreateDate" disabled/>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td valign="top" id="findpettd" style="display:inline; padding-left:30px;">
                                <table align="right" width="125">
                                    <tr><td style="background-color:#efefef;padding:5px; border-left:solid #c00 5px;"> 可能相关</td></tr>
                                    <tr>
                                        <td id="findpetList">正在匹配...</td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </b>
                <b style="display">
                    <table align="center" id="reEdit" style="display:none;">
                        <tr>
                            <td>
                                标记删除：
                            </td>
                            <td>
                                <input id="isdeleted" type="checkbox" />
                            </td>
                        </tr>
                        <tr>
                            <td>
                                状态：
                            </td>
                            <td>
                                <select id="state"">
                                    <option value="未审核">未审核</option>
                                    <option value="已审核">已审核</option>
                                    <option value="处理中">处理中</option>
                                    <option value="已完成">已完成</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td valign=top>
                                处理记录：
                            </td>
                            <td>
                                <textarea  id="resulttext" rows="10" style="width:300px;"></textarea >
                            </td>
                        </tr>
                        <tr>
                            <td>
                                修改时间：
                            </td>
                            <td>
                                <input id="UpdateDate" disabled/>
                            </td>
                        </tr>
                    </table>
                </b>
            </td>
        </tr>

        <tr>
            <td align="center" class="functions" style="padding:20px;">
                <button onclick="fnSave()">保存</button>
            </td>
        </tr>
    </table>
</body>

<script>
function fnOpen()
{
	fnOpenEx(86, _mod);
}
function bodyonload() {

	fnReset();
	//Automate
	if(typeof(parameter)=="object") 
	{
	    if (parameter("title") != undefined) Name.value = parameter("title");
	    fnLoad(parameter("ID"));
		parameter.Remove("ID");
	}
}

function fnLoad(id) {
    var n, srcElem;
    if ((n = validInt(id)) > 0) {
        sAlert(1);
        var param = zydataRead();
        param("id") = n;
        if (window.event && (srcElem = window.event.srcElement)) srcElem.disabled = true;
        docData(_mod + ".Load", param, cbLoad);
    }

    function cbLoad(data, result) {
        if (srcElem) srcElem.disabled = false;
        if (result == 0) {
            mapping(TOSTORAGE, data);
            getFindpetRs();
            if (placepoint.value != "") {
                mapTR.style.display = "";
                var map = new BMap.Map("allmap"),
                point = new BMap.Point(placepoint.value.split(',')[0], placepoint.value.split(',')[1]);

                map.centerAndZoom(point, 15);
                var mk = new BMap.Marker(point);
                map.clearOverlays();
                map.addOverlay(mk);
                //map.panTo(point);
                map.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
                map.enableContinuousZoom();    //启用地图惯性拖拽，默认禁用
            } else {
                selectPlace.style.display = "";
                placeText.size = 30;
            }
            if (imgText.value != "") {
                var imgHTML = "";
                for (var url in imgText.value.split(',')) {
                    imgHTML += "<a href='http://www.xunchongbao.cn" + imgText.value.split(',')[url] + "' target='_blank'><img src='http://www.xunchongbao.cn" + imgText.value.split(',')[url] + "' style='width:200px;border:0px;'></a><br><br>";
                }
                imgTD.innerHTML = imgHTML;
                imgTR.style.display = "";
            }
            reEdit.style.display = "";
        }
        if (id.value != undefined) session("BillID") = ID.value;
        sAlert(0);
    }
}

function selectPlaceClick() {
    mapTR.style.display = "";
    placeText.disabled = false;
    placeText.size = 35;
    selectPlace.innerText = "搜索";
    //allmap.style.width = "400px";
    //allmap.style.height = "300px";
    var map = new BMap.Map("allmap"),
        point = new BMap.Point();

    map.centerAndZoom(point, 12);
    var mk = new BMap.Marker(point);
    map.clearOverlays();
    map.addOverlay(mk);
    //map.panTo(point);
    map.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
    map.enableContinuousZoom();    //启用地图惯性拖拽，默认禁用
    var geoc = new BMap.Geocoder();
    var local = new BMap.LocalSearch(map, {
        renderOptions: { map: map }
    });
    local.search(placeText.value);

    map.addEventListener("click", function(e) {
        var pt = e.point;
        var mk = new BMap.Marker(pt);
        map.clearOverlays();
        map.addOverlay(mk);
        map.panTo(pt);

        geoc.getLocation(pt, function(rs) {
            var addComp = rs.addressComponents;
            var p = addComp.province + "," + addComp.city + "," + addComp.district + "," + addComp.street + "," + addComp.streetNumber;
            placepoint.value = pt.lng + ',' + pt.lat;
            placeText.value = p;
        });
    });

}

function getFindpetRs() {
    var param = zydataRead();
    param("timeInput") = timeInput.value;
    param("Varieties") = Varieties.value;
    param("placeText") = placeText.value;
    param("sendType") = sendType.checked ? 1 : 0;
    
    docData(_mod + ".findpet", param, cbLoad);
    function cbLoad(data, result) {
        if (result == 0) {
            var finddiv = "无相关记录。", imgstr = "";
            fRs = data("findpetRs")
            if (fRs.recordcount > 0) {
                fRs.movefirst();
                finddiv = "";
            }
            while (!fRs.eof) {
                finddiv += "<table width='120' onclick='btnEditClick(" + fRs("id").value + ");' style='cursor:hand;'>";
                if (fRs("imgText").value != "") {
                    imgstr = "<tr><td><img src='http://www.xunchongbao.cn" + fRs("imgText").value.split(",")[0] + "' style='width:120px;border:0px;'></td></tr>";
                } else {
                    imgstr = "";
                }
                finddiv += imgstr + "<tr><td style='font-size:12px;'>" + fRs("Varieties").value + "</td></tr>";
                finddiv += "<tr><td style='font-size:12px;'>" + fRs("Color").value.split(",")[0] + "</td></tr>";
                finddiv += "<tr><td style='font-size:12px;'>" + fRs("placeText").value.split(",")[0] + "・" + fRs("placeText").value.split(",")[1] + "</td></tr>";
                finddiv += "<tr><td style='font-size:10px;color:#aaa;'>" + fRs("timeInputFmt").value + "</td></tr>";
                finddiv += "<tr><td><hr size=1></td></tr>";
                finddiv += "</table>";
			    fRs.movenext();
			}
			findpetList.innerHTML = finddiv;
		}
    }
}

function defisFindMapping(direct, device, mapitem, user1, user2, user3, user4) {
    switch (direct) {
        case TODEVICE:
            //device(mapitem.group)(mapitem.keyword) = mapitem.storage.value; 
            break;
        case TOSTORAGE:
            //alert(device(mapitem.group)(mapitem.keyword))
            isFind.style.display = ((device(mapitem.group)(mapitem.keyword) > 0) ? 'inline' : 'none');
            isFind.onclick = function() {
                var uid, param = zydataRead(), modEdit;
                if (!(param("ID") = device(mapitem.group)(mapitem.keyword))) return;
                if (!(modEdit = "寻宠记录")) return;
                var title = "查看" + modEdit;
                if (!title) title = "";
                uid = CreateWindow(title, -1, -1, -1, -1, WS_CAPTION | WS_SCROLL | WS_THICKFRAME | WS_VISIBLE);
                docModuleAsWindow(uid, "xcjl", param);
            }
            //alert(mapitem.storage.value)
            //mapitem.storage.value = CString(device(mapitem.group)(mapitem.keyword).value);
            //isFind.style.display = ((mapitem.storage.value > > 0) ? 'inline' : 'none'); 
            break;
        case RESET:
            break;
    }
}

/*-------------------
作者：张峥
日期：2011-8-18
作用：打开相应单据
---------------------*/
function btnEditClick(id) {
    var uid, param = zydataRead(), modEdit ;

    if (!(param("ID") = id)) return;
    if (!(modEdit = "寻宠记录")) return;
    var title = "查看" + modEdit;
    if (!title) title = "";
    uid = CreateWindow(title, -1, -1, -1, -1, WS_CAPTION | WS_SCROLL | WS_THICKFRAME | WS_VISIBLE);
    docModuleAsWindow(uid, "xcjl", param);
}


map(_mod,"AddNew","","",defAddNewMapping);
map(_mod, 'ID', ID, "", defTextMapping);
map(_mod, 'sendType', sendType, MAPINT, defCheckBoxMapping);
map(_mod, 'isRe', isRe, MAPINT, defCheckBoxMapping);
map(_mod, 'isdeleted', isdeleted, MAPINT, defCheckBoxMapping);
map(_mod, 'isFind', isFind, MAPINT, defisFindMapping);
map(_mod, 'timeInput', timeInput, MAPSTRING, defTextNotNullMapping);
map(_mod, 'placeText', placeText, MAPSTRING, defTextNotNullMapping);
map(_mod, 'placepoint', placepoint, MAPSTRING, defTextMapping);
map(_mod, 'Varieties', Varieties, MAPSTRING, defTextNotNullMapping);
map(_mod, 'Gender', Gender, MAPSTRING, defTextNotNullMapping);
map(_mod, 'sterilization', sterilization, MAPSTRING, defTextNotNullMapping);
map(_mod, 'color', color, MAPSTRING, defTextNotNullMapping);
map(_mod, 'isname', isname, MAPSTRING, defTextNotNullMapping);
map(_mod, 'phone', phone, MAPSTRING, defTextNotNullMapping);
map(_mod, 'amount', amount, MAPINT, defTextMapping);
map(_mod, 'memo', memo, MAPSTRING, defTextMapping);
map(_mod, 'imgText', imgText, MAPSTRING, defTextMapping);
map(_mod, 'state', state, MAPSTRING, defSelectMapping);
map(_mod, 'resulttext', resulttext, MAPSTRING, defTextMapping);
map(_mod, 'CreateDate', CreateDate, "", defTextMapping);
map(_mod, 'UpdateDate', UpdateDate, "", defTextMapping);

</script>

</html>
